<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./assets/css/table.css">
    <link rel="stylesheet" href="./assets/css/cart.css">
    <link rel="stylesheet" href="./assets/css/VinylList.css">
    <link rel="stylesheet" href="./assets/css/general.css">

    <title>Titel</title>
    <style></style>

    <script src="./assets/js/jquery-3.7.1.js"></script>
    <script type="module">
        'use strict';
        import { get } from './assets/js/CRUD.js';
        import { initTable } from './assets/js/Table.js';
        import { initCart } from './assets/js/cart.js'
        import { createFooter } from './assets/js/footer.js'
        // KONSTANTEN / VARIABLEN
        const elements = {}


        const filterClick = (evt) => {
            /**
             *  Click event for the filter button. Adding an highlight class to the filter dom element
             *  on the navbar. Also or removes the clicked filter from the filter array.
             * */
            const target = evt.currentTarget;
            target.classList.toggle('highlight')
            if (target.classList.contains('highlight') &&
                !elements.filterArr.includes(evt.currentTarget.innerText)) {
                // add to Filter array
                elements.filterArr.push(evt.currentTarget.innerText);
            } else {
                // removing from the filters array
                elements.filterArr = elements.filterArr.filter(el => {
                    el == evt.currentTarget.innerText ? 0 : 1
                })

                // if the filterarray is empty, reset the currentRowAmount to 10
                if(!elements.filterArr.length) localStorage.setItem('currentRowAmount', "10")  
            }

            // render the table with the applied filters
            initTable(elements.tableHead, elements.tableBody, elements.tableFoot, elements.articles, elements.filterArr)
        }

        const appendEventlisteners = () => {
            /**
             * add the Eventlistener like the filter function for the genre / subegenre navbar
             * */

            // Genre / SubGenre click event
            for (const el of Array.from(document.querySelectorAll("li"))) {
                el.addEventListener('click', filterClick);
            }
        }

        const createFilter = ({ headerText = "Genre", bulletPoints } = {}) => {
            /**
             * Appends the genre / sub genre filter to the navigation
             * */
            const nav = document.querySelector("#nav")
            const head = document.createElement("h2");
            head.innerText = headerText;
            nav.append(head)
            bulletPoints.forEach((el) => {
                let item = document.createElement("li");
                item.innerText = el.name;
                nav.append(item)
            });
        }

        const loadData = async () => {
            /**
             * First, load all the data we need
             */

            elements.articles = await get({
                url: "http://192.168.0.2:5000/select_all_articles",
                body: "Model.Vinyl.Record.Record"
            });

            elements.genre = await get({
                url: "http://192.168.0.2:5000/select",
                body: {
                    "table": "genre",
                    "fields": ["name"]
                }
            });

            elements.subGenre = await get({
                url: "http://192.168.0.2:5000/select",
                body: {
                    "table": "sub_genre",
                    "fields": ["name"]
                }
            });
            console.log(elements.articles);
            // set the genre / subgenres for the bulletpoints

            // also create an array with all genres so the filtering is easier 
            // (only one array instead of both genre and subgenre array)
            elements.tableHead = document.querySelector("#head")
            elements.tableBody = document.querySelector("#body")
            elements.tableFoot = document.querySelector("#foot")
            elements.filterArr = []
        }

        const initVinyl = async () => {
            await loadData();
            createFilter({ bulletPoints: elements.genre });
            createFilter({ headerText: "Sub Genre", bulletPoints: elements.subGenre });
            appendEventlisteners();
            initTable(elements.tableHead, elements.tableBody, elements.tableFoot, elements.articles, elements.filterArr)
            initCart(elements.articles)
            document.querySelector(".cardContainer").append(createFooter())
            
        }

        // INIT
        document.addEventListener('DOMContentLoaded', initVinyl)
        // todo: Tabelle nur x viele Daten anzeigen
        // button der unten an der Tabelle klebt
        // Anderes design fuer die nav Filter Geschichte



    </script>
</head>

<body>
    <div class="body cardContainer">
        <header>
            <div class="shopping">
                <img src="./assets/images/bag.svg">
                <span class="quantity">0</span>
            </div>
        </header>

        <div class="list">

        </div>
    </div>
    <div class="card">
        <h1>Card</h1>
        <ul class="listCard">
        </ul>
        <div class="checkOut">
            <div class="total">0</div>
            <div class="closeShopping">Close</div>
        </div>
    </div>


    <div class="left container">
        <div class="left" id="filter"></div>
        <ul id="nav">

        </ul>
    </div>
    <div class="tableContainer">
        <table class="dataTable">
            <thead id="head"></thead>
            <tbody id="body"></tbody>
            <tfoot id="foot"></tfoot>
        </table>
    </div>

</body>

</html>